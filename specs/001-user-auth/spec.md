# Feature Specification: ユーザー認証とログイン

**Feature Branch**: `001-user-auth`  
**Created**: 2025-10-25  
**Status**: Draft  
**Input**: User description: "ユーザー認証とログイン
ユーザーがアプリのURLにアクセスすると、最初にログイン画面が表示されます。ユーザーIDとパスワードを入力したらログインでき、ログインが成功するとホーム画面に遷移します。
もし、別のメニューのURLにアクセスしてセッションがなかった場合は、ログイン画面を表示して、ログインが成功した時は最初にアクセスしたページに遷移します。
openapiはすでに定義してあり、schema/auth/openapi.yaml を使います。"

## Clarifications

### Session 2025-10-25

- Q: User Story 2でログイン試行回数制限のシナリオは必要か？ → A: 不要。複数回ログイン失敗時の試行回数上限エラーは実装しない

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 基本的なログイン (Priority: P1)

ユーザーはアプリケーションのトップURLにアクセスし、ログイン画面でユーザーID（メールアドレスまたはユーザー名）とパスワードを入力してログインします。ログインが成功するとホーム画面に遷移し、アプリケーションの機能を利用できるようになります。

**Why this priority**: アプリケーションへのアクセスに必須の最も基本的な機能であり、すべての認証済み機能の前提条件です。

**Independent Test**: ログイン画面に有効な認証情報を入力し、ホーム画面への遷移とセッション確立を確認することで独立してテスト可能です。

**Acceptance Scenarios**:

1. **Given** ユーザーがログアウト状態でアプリのトップURLにアクセスする、**When** ログイン画面が表示される、**Then** ユーザーIDとパスワードの入力フィールド、ログインボタンが表示される
2. **Given** ログイン画面で有効なユーザーID（メールアドレス）とパスワードを入力する、**When** ログインボタンをクリックする、**Then** ログインが成功しホーム画面に遷移する
3. **Given** ログイン画面で有効なユーザーID（ユーザー名）とパスワードを入力する、**When** ログインボタンをクリックする、**Then** ログインが成功しホーム画面に遷移する
4. **Given** ログインに成功した後、**When** ユーザーが任意のページにアクセスする、**Then** セッションが維持され認証が必要なページにアクセスできる

---

### User Story 2 - ログイン失敗時のエラー処理 (Priority: P1)

ユーザーが無効な認証情報でログインを試みた場合、適切なエラーメッセージが表示され、再度ログインを試みることができます。

**Why this priority**: セキュリティとユーザビリティの両面から重要で、基本ログイン機能と同時に実装すべき機能です。

**Independent Test**: 無効な認証情報でログインを試み、エラーメッセージの表示とフォームの状態を確認することで独立してテスト可能です。

**Acceptance Scenarios**:

1. **Given** ログイン画面で無効なユーザーIDまたはパスワードを入力する、**When** ログインボタンをクリックする、**Then** エラーメッセージ「メールアドレス/ユーザー名またはパスワードが正しくありません」が表示される
2. **Given** エラーメッセージが表示されている、**When** ユーザーが再度認証情報を入力する、**Then** エラーメッセージがクリアされ、再度ログインを試みることができる

---

### User Story 3 - 保護されたページへの直接アクセス (Priority: P1)

ユーザーがセッションなしで保護されたページのURLに直接アクセスした場合、ログイン画面にリダイレクトされ、ログイン成功後に元々アクセスしようとしたページに遷移します。

**Why this priority**: ユーザーが直接URLを入力したりブックマークからアクセスした際のUXを向上させる重要な機能です。

**Independent Test**: セッションなしで保護されたページのURLに直接アクセスし、ログイン後のリダイレクトを確認することで独立してテスト可能です。

**Acceptance Scenarios**:

1. **Given** ユーザーがセッションなしで保護されたページURL（例：`/dashboard`）に直接アクセスする、**When** ページが読み込まれる、**Then** ログイン画面にリダイレクトされる
2. **Given** 保護されたページから自動的にリダイレクトされたログイン画面で有効な認証情報を入力する、**When** ログインが成功する、**Then** 元々アクセスしようとした保護されたページ（`/dashboard`）に遷移する
3. **Given** 保護されたページから自動的にリダイレクトされたログイン画面、**When** ユーザーがブラウザの戻るボタンをクリックする、**Then** 再度保護されたページへのアクセスが試みられ、ログイン画面に戻される

---

### User Story 4 - ログアウト (Priority: P2)

ログイン済みのユーザーがログアウトボタンをクリックすることで、セッションを終了し、ログイン画面に戻ることができます。

**Why this priority**: セキュリティとプライバシー保護のために必要ですが、基本的なログイン機能の後に実装可能です。

**Independent Test**: ログイン済みの状態からログアウトボタンをクリックし、セッション破棄とログイン画面への遷移を確認することで独立してテスト可能です。

**Acceptance Scenarios**:

1. **Given** ユーザーがログイン済みでホーム画面にいる、**When** ログアウトボタンをクリックする、**Then** セッションが破棄されログイン画面に遷移する
2. **Given** ログアウト後、**When** ユーザーが保護されたページのURLに直接アクセスする、**Then** ログイン画面にリダイレクトされる
3. **Given** ログアウト後、**When** ブラウザの戻るボタンをクリックする、**Then** 保護されたページには戻れず、ログイン画面が表示される

---

### User Story 5 - ログイン状態の維持（Remember Me） (Priority: P3)

ユーザーがログイン時に「ログイン状態を保持」チェックボックスを選択することで、ブラウザを閉じてもセッションが維持され、次回アクセス時に自動的にログイン済み状態になります。

**Why this priority**: ユーザーの利便性を向上させる機能ですが、基本的なログイン機能が動作した後に追加可能です。

**Independent Test**: 「ログイン状態を保持」を有効にしてログインし、ブラウザを再起動後もセッションが維持されることを確認することで独立してテスト可能です。

**Acceptance Scenarios**:

1. **Given** ログイン画面で「ログイン状態を保持」チェックボックスが表示される、**When** ユーザーがチェックボックスを選択してログインする、**Then** 長期間有効なセッションが作成される
2. **Given** 「ログイン状態を保持」を有効にしてログインした後、**When** ブラウザを完全に閉じて再度開く、**Then** ユーザーは自動的にログイン済み状態でアプリケーションにアクセスできる
3. **Given** 「ログイン状態を保持」を無効にしてログインした後、**When** ブラウザを完全に閉じて再度開く、**Then** セッションが終了しログイン画面が表示される

---

### Edge Cases

- ログイン中にネットワークエラーが発生した場合、適切なエラーメッセージが表示され、ユーザーは再試行できる
- セッションの有効期限が切れた状態で保護されたページにアクセスした場合、ログイン画面にリダイレクトされ「セッションの有効期限が切れました。再度ログインしてください」というメッセージが表示される
- 複数のブラウザタブで同じアカウントでログインした場合、すべてのタブでセッションが共有される
- ログイン後、別のタブでログアウトした場合、他のタブで保護されたページにアクセスしようとするとログイン画面にリダイレクトされる
- ユーザーIDまたはパスワードのフィールドが空の場合、ログインボタンをクリックすると「ユーザーIDとパスワードを入力してください」という検証エラーが表示される
- パスワードフィールドは常にマスクされて表示される

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: システムはログイン画面で、ユーザーID（メールアドレスまたはユーザー名）とパスワードの入力フィールドを提供しなければならない
- **FR-002**: システムは入力されたユーザーIDとパスワードをOpenAPI仕様（`schema/auth/openapi.yaml`）に基づいて検証し、`/api/auth/login`エンドポイントに送信しなければならない
- **FR-003**: システムはログイン成功時にサーバーから返されたセッションCookieを保存し、以降のリクエストに含めなければならない
- **FR-004**: システムはログイン成功後、ユーザーをホーム画面（`/`）に遷移させなければならない
- **FR-005**: システムはログイン失敗時に、APIから返されたエラーメッセージをユーザーに表示しなければならない（例：「メールアドレス/ユーザー名またはパスワードが正しくありません」）
- **FR-006**: システムは保護されたページへのアクセス時にセッションの有無をチェックし、セッションがない場合はログイン画面にリダイレクトしなければならない
- **FR-007**: システムはログイン画面へのリダイレクト時に、元々アクセスしようとしたURLを記憶し、ログイン成功後にそのURLに遷移させなければならない
- **FR-008**: システムはログアウトボタンの実行時に`/api/auth/logout`エンドポイントを呼び出し、セッションを破棄してログイン画面に遷移しなければならない
- **FR-009**: システムは「ログイン状態を保持」チェックボックスを提供し、選択時は`rememberMe`パラメータを`true`でAPIに送信しなければならない
- **FR-010**: システムはセッション有効期限切れ（401エラー）を検知した場合、ログイン画面にリダイレクトし「セッションの有効期限が切れました」というメッセージを表示しなければならない
- **FR-011**: システムはネットワークエラー発生時に、ユーザーに適切なエラーメッセージを表示し、再試行を促さなければならない

### Key Entities

- **User**: ユーザー情報を表すエンティティ。属性：ユーザーID（UUID）、ユーザー名、メールアドレス、フルネーム
- **Session**: セッション情報を表すエンティティ。属性：セッションID（Cookie）、有効期限、CSRFトークン
- **LoginRequest**: ログインリクエストのデータ。属性：ユーザーID（メールまたはユーザー名）、パスワード、ログイン状態保持フラグ
- **LoginResponse**: ログインレスポンスのデータ。属性：ユーザー情報、セッション情報、メッセージ

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: ユーザーはログイン画面で認証情報を入力してから3秒以内にログイン結果（成功またはエラー）を確認できる
- **SC-002**: 95%以上のユーザーが初回アクセス時にログイン画面を正しく表示でき、ログインフォームを問題なく操作できる
- **SC-003**: 保護されたページへの直接アクセス時、100%のケースでログイン画面へのリダイレクトが正しく動作し、ログイン後に元のページに戻れる
- **SC-004**: ログイン失敗時、100%のケースで適切なエラーメッセージが表示され、ユーザーは何が問題だったかを理解できる
- **SC-005**: ログアウト操作後、100%のケースでセッションが確実に破棄され、保護されたページへのアクセスが拒否される
- **SC-006**: 「ログイン状態を保持」機能を使用した場合、ブラウザ再起動後も95%以上のケースでセッションが維持される

## Assumptions

- OpenAPI仕様（`schema/auth/openapi.yaml`）に定義されているAPIエンドポイントはバックエンド側ですでに実装されている、または並行して開発される
- セッションCookieは`HttpOnly`、`Secure`、`SameSite=Strict`属性で設定される（セキュリティはバックエンドで担保）
- CSRF保護はバックエンド側で実装されており、必要に応じてフロントエンドでCSRFトークンをヘッダーに含める
- ユーザーIDとしてメールアドレスとユーザー名の両方が使用可能（バックエンドが判定）
- パスワードの複雑性要件（最小8文字、最大36文字）はバックエンド側で検証される

## Dependencies

- OpenAPI仕様ファイル：`schema/auth/openapi.yaml`
- バックエンドAPIエンドポイント：`/api/auth/login`、`/api/auth/logout`、`/api/auth/session`
- React Router v7による保護されたルートの実装
- Axios HTTPクライアント（Cookie自動送信サポート）
- MSW（Mock Service Worker）によるテスト時のAPIモック
