# Feature Specification: 文書管理システム

**Feature Branch**: `002-document-management`  
**Created**: 2025-10-26  
**Status**: Draft  
**Input**: User description: "文書管理アプリを作りたいです。チームで文書を共有・整理するためのシンプルな管理システム。従来のファイルサーバーやメール添付での文書共有には、「どこに何があるか分からない」「最新版がどれか不明」「検索しにくい」といった課題があります。このアプリは、直感的なUIで誰でも簡単に文書をアップロード・分類・検索できるようにし、チームの文書管理を効率化します。"

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 文書のアップロードと基本情報登録 (Priority: P1) 🎯 MVP

事務スタッフが取引先から受け取った請求書PDFをドラッグ&ドロップでアップロードし、「請求書」と「未処理」タグを設定する。アップロード進捗が表示され、完了後に文書一覧に追加される。

**Why this priority**: 文書管理システムの最も基本的な機能。文書をシステムに取り込めなければ何も始まらない。ドラッグ&ドロップの直感的なUIにより、ITリテラシーが中程度のユーザーでも迷わず使える。

**Independent Test**: ファイルをドラッグ&ドロップでアップロードし、基本情報（ファイル名、タグ）を設定して保存できることを確認。

**Acceptance Scenarios**:

1. **Given** ユーザーがダッシュボードにいる状態で、**When** PDFファイルを画面上にドラッグ&ドロップすると、**Then** アップロードエリアがハイライトされ、ファイルが選択される
2. **Given** ファイルが選択された状態で、**When** タグを「請求書」「未処理」に設定して「アップロード」ボタンをクリックすると、**Then** プログレスバーが表示され、完了後に文書一覧に追加される
3. **Given** 複数のファイル（PDF、Word、Excel、画像）を選択した状態で、**When** アップロードを実行すると、**Then** 各ファイルのプログレスバーが表示され、すべて完了後に一覧に追加される
4. **Given** 10MBを超えるファイルを選択した状態で、**When** アップロードを試みると、**Then** 「ファイルサイズが上限を超えています（最大10MB）」とエラーメッセージが表示される

---

### User Story 2 - 文書一覧の表示と閲覧 (Priority: P1) 🎯 MVP

プロジェクトメンバーが文書一覧画面を開くと、チームがアップロードした全文書が表示される。リストビューまたはグリッドビューで表示形式を切り替え、ファイル名や更新日時でソートできる。

**Why this priority**: 文書をアップロードした後、それを見つけて確認できなければ意味がない。一覧表示とソート機能により、ユーザーは必要な文書に素早くアクセスできる。

**Independent Test**: 文書一覧画面で複数の文書が表示され、リスト/グリッドビューの切り替え、ソート、ページネーションが機能することを確認。

**Acceptance Scenarios**:

1. **Given** 文書が5件登録されている状態で、**When** 文書一覧画面を開くと、**Then** 5件すべてがリストビューで表示され、各文書のファイル名、タグ、アップロード日時、ファイルサイズが確認できる
2. **Given** リストビューで表示されている状態で、**When** 「グリッドビュー」ボタンをクリックすると、**Then** カード形式のグリッドビューに切り替わる
3. **Given** 文書一覧が表示されている状態で、**When** 「ファイル名（昇順）」でソートすると、**Then** ファイル名のアルファベット順に並び替えられる
4. **Given** 文書が25件登録されている状態で、**When** 文書一覧を開くと、**Then** 最初の20件が表示され、ページネーションで次のページに移動できる

---

### User Story 3 - キーワード検索で文書を探す (Priority: P1) 🎯 MVP

営業担当者が「田中商事」とキーワード検索すると、ファイル名に「田中商事」を含む文書が一覧表示される。検索結果のファイル名はハイライトされ、該当する文書を素早く見つけられる。

**Why this priority**: 文書が増えると一覧から探すのは困難になる。キーワード検索により、ユーザーは目的の文書を数秒で見つけられる。これがなければ文書管理システムの価値が半減する。

**Independent Test**: 検索バーにキーワードを入力し、ファイル名またはタグ名が一致する文書が表示されることを確認。

**Acceptance Scenarios**:

1. **Given** ファイル名に「田中商事*請求書.pdf」「佐藤建設*契約書.docx」がある状態で、**When** 検索バーに「田中商事」と入力すると、**Then** 「田中商事\_請求書.pdf」のみが表示され、ファイル名の「田中商事」がハイライトされる
2. **Given** タグに「緊急」が付いた文書がある状態で、**When** 「緊急」と検索すると、**Then** そのタグが付いた文書が表示される
3. **Given** 検索結果が表示されている状態で、**When** 検索バーをクリアすると、**Then** すべての文書が再表示される
4. **Given** 検索バーに「存在しないキーワード」と入力した状態で、**When** 検索を実行すると、**Then** 「該当する文書が見つかりませんでした」とメッセージが表示される

---

### User Story 4 - タグでフィルタリング (Priority: P2)

経理担当者が「請求書」と「未処理」タグでフィルタをかけると、両方のタグが付いた文書のみが表示される。複数のタグを組み合わせることで、必要な文書を効率的に絞り込める。

**Why this priority**: キーワード検索だけでは探しにくい場合がある。タグフィルタ機能により、特定の条件に合致する文書を一覧で確認でき、業務の効率が向上する。

**Independent Test**: タグのフィルタを適用し、条件に合致する文書のみが表示されることを確認。

**Acceptance Scenarios**:

1. **Given** 「請求書」「契約書」「議事録」タグが付いた文書がそれぞれ登録されている状態で、**When** タグフィルタで「請求書」を選択すると、**Then** 「請求書」タグが付いた文書のみが表示される
2. **Given** 「未処理」「処理中」「完了」のタグが付いた文書がある状態で、**When** タグフィルタで「未処理」を選択すると、**Then** 「未処理」タグが付いた文書のみが表示される
3. **Given** フィルタが適用されている状態で、**When** 「請求書」と「未処理」タグを同時に選択すると、**Then** 両方のタグが付いている文書のみが表示される
4. **Given** アップロード日付範囲フィルタで「2024年1月1日〜2024年3月31日」を設定すると、**When** フィルタを適用すると、**Then** その期間にアップロードされた文書のみが表示される

---

### User Story 5 - 文書の詳細表示とダウンロード (Priority: P2)

法務担当者が契約書ファイルをクリックすると詳細画面が開き、契約書のPDFプレビューが表示される。内容を確認した後、「ダウンロード」ボタンで元のファイルをローカルに保存できる。

**Why this priority**: 文書の内容を確認せずにダウンロードするのは非効率。プレビュー機能により、ブラウザ内で素早く内容を確認でき、必要なファイルだけをダウンロードできる。

**Independent Test**: 文書をクリックして詳細画面を開き、プレビュー表示とダウンロード機能が動作することを確認。

**Acceptance Scenarios**:

1. **Given** PDFファイルが登録されている状態で、**When** そのファイルをクリックすると、**Then** 詳細画面が開き、PDFがブラウザ内でプレビュー表示される
2. **Given** 詳細画面が表示されている状態で、**When** 「ダウンロード」ボタンをクリックすると、**Then** 元のファイルがローカルにダウンロードされる
3. **Given** 画像ファイル（.jpgまたは.png）が登録されている状態で、**When** そのファイルをクリックすると、**Then** 画像がブラウザ内でプレビュー表示される
4. **Given** 文書一覧で複数のファイルを選択した状態で、**When** 「一括ダウンロード」ボタンをクリックすると、**Then** 選択したファイルがZIP形式でダウンロードされる

---

### User Story 6 - タグの作成と管理 (Priority: P2)

プロジェクトリーダーがタグ管理画面で「2024年度」「緊急」「承認済」などの新しいタグを作成し、色を設定する。作成したタグは文書のアップロード時や編集時に選択できる。

**Why this priority**: チームごとに必要なタグが異なるため、ユーザーが自由にタグを作成・管理できることが重要。色分け機能により、視覚的に重要度や状態を区別できる。

**Independent Test**: タグ管理画面で新しいタグを作成し、色を設定して保存できることを確認。作成したタグが文書のタグ選択時に表示されることを確認。

**Acceptance Scenarios**:

1. **Given** タグ管理画面を開いた状態で、**When** 「新しいタグを作成」ボタンをクリックし、タグ名「緊急」、色「赤」を入力して保存すると、**Then** タグ一覧に「緊急（赤）」が追加される
2. **Given** タグ「緊急」が作成されている状態で、**When** 文書アップロード画面でタグを選択すると、**Then** 「緊急」が選択肢に表示される
3. **Given** タグ「緊急」が作成されている状態で、**When** タグ管理画面でタグ名を「最優先」に変更すると、**Then** 既存の文書に付与された「緊急」タグも「最優先」に更新される
4. **Given** タグ「完了」が作成されている状態で、**When** タグ管理画面で「完了」タグを削除すると、**Then** 削除確認ダイアログが表示され、確認後にタグが削除される

---

### User Story 7 - 文書のメタデータ編集 (Priority: P3)

事務スタッフが誤って「契約書」タグで登録した文書を、詳細画面から「議事録」に変更する。ファイル名も「会議記録_20240115.pdf」に変更し、タグに「2024年度」を追加する。

**Why this priority**: 人間はミスをするもの。アップロード後にタグを変更できることで、ユーザーは安心して文書を登録できる。ただし、基本的なアップロードや検索機能の後に実装すべき機能。

**Independent Test**: 文書の詳細画面からファイル名、タグを編集し、保存できることを確認。

**Acceptance Scenarios**:

1. **Given** 文書の詳細画面が表示されている状態で、**When** 「編集」ボタンをクリックすると、**Then** ファイル名、タグの入力フィールドが編集可能になる
2. **Given** 編集モードの状態で、**When** ファイル名を「会議記録_20240115.pdf」に変更し、「保存」ボタンをクリックすると、**Then** 変更が反映され、文書一覧でも新しいファイル名が表示される
3. **Given** 編集モードの状態で、**When** タグ「契約書」を削除し、「議事録」を追加すると、**Then** 変更が保存され、一覧画面でも「議事録」タグが表示される
4. **Given** 編集モードの状態で、**When** タグに「2024年度」を追加すると、**Then** そのタグが文書に付与され、タグフィルタで絞り込めるようになる

---

### User Story 8 - 文書の削除とゴミ箱からの復元 (Priority: P3)

プロジェクトメンバーが古い提案書を削除すると、その文書はゴミ箱に移動する。誤って削除した場合は、ゴミ箱から復元できる。ゴミ箱の文書は30日後に自動削除される。

**Why this priority**: 誤削除のリスクを軽減するため、ゴミ箱機能は重要。ただし、文書の検索や閲覧といった主要機能の後に実装すべき安全機能。

**Independent Test**: 文書を削除してゴミ箱に移動し、ゴミ箱から復元できることを確認。30日後の自動削除は期間設定で検証。

**Acceptance Scenarios**:

1. **Given** 文書一覧で文書を選択した状態で、**When** 「削除」ボタンをクリックすると、**Then** 「この文書を削除しますか？」と確認ダイアログが表示される
2. **Given** 削除確認ダイアログで「削除」を選択すると、**When** 削除が実行されると、**Then** 文書は一覧から消え、ゴミ箱に移動する
3. **Given** ゴミ箱に文書がある状態で、**When** ゴミ箱を開いて文書を選択し「復元」ボタンをクリックすると、**Then** 文書が元の場所に復元され、文書一覧に再表示される
4. **Given** ゴミ箱に移動してから30日が経過した文書がある状態で、**When** システムの日次処理が実行されると、**Then** その文書は完全に削除される

---

### User Story 9 - 検索条件の保存と再利用 (Priority: P3)

経理担当者が「タグ: 請求書、未処理、日付範囲: 今月」という検索条件を「未処理請求書（今月）」として保存する。次回以降、この保存された検索条件をワンクリックで適用できる。

**Why this priority**: 頻繁に使う検索条件を毎回入力するのは非効率。保存機能により、繰り返し作業が削減される。ただし、基本的な検索・フィルタ機能が実装された後の改善機能。

**Independent Test**: 検索条件を保存し、保存した条件をワンクリックで再適用できることを確認。

**Acceptance Scenarios**:

1. **Given** タグ「請求書」「未処理」でフィルタを適用した状態で、**When** 「この検索条件を保存」ボタンをクリックし、名前「未処理請求書」を入力すると、**Then** 検索条件が保存される
2. **Given** 検索条件「未処理請求書」が保存されている状態で、**When** 保存された検索条件一覧から「未処理請求書」を選択すると、**Then** そのフィルタが自動的に適用される
3. **Given** 保存された検索条件がある状態で、**When** 検索条件一覧で「編集」ボタンをクリックすると、**Then** 条件を変更して再保存できる
4. **Given** 保存された検索条件がある状態で、**When** 「削除」ボタンをクリックすると、**Then** 削除確認後に検索条件が削除される

---

### Edge Cases

- **大量ファイルの同時アップロード**: 20ファイルを超える選択をした場合、「一度にアップロードできるのは最大20ファイルまでです」とエラーメッセージを表示
- **対応していないファイル形式**: .zipや.exeなどの対応外形式をアップロードしようとした場合、「このファイル形式はサポートされていません（対応形式: PDF, Word, Excel, 画像）」とエラー表示
- **ネットワーク切断中のアップロード**: アップロード中にネットワークが切断された場合、「ネットワークエラーが発生しました。接続を確認してください」と表示し、再試行ボタンを提供
- **同名ファイルのアップロード**: 既に同じファイル名の文書が存在する場合、「同じ名前のファイルが既に存在します。上書きしますか？」と確認ダイアログを表示
- **タグの削除時に使用中の場合**: あるタグが複数の文書に使用されている状態で削除しようとした場合、「このタグは○件の文書で使用されています。削除すると全ての文書からタグが削除されます」と警告表示
- **ゴミ箱が空の場合**: ゴミ箱に文書がない状態でゴミ箱を開いた場合、「ゴミ箱は空です」とメッセージを表示
- **検索結果がゼロ件の場合**: 検索またはフィルタの結果が0件の場合、「該当する文書が見つかりませんでした。検索条件を変更してください」と表示
- **複数選択時の一括操作**: 文書一覧で複数選択（Shift+クリックまたはCtrl+クリック）を行い、一括ダウンロードや一括削除が実行できる

## Requirements _(mandatory)_

### Functional Requirements

#### 文書アップロード

- **FR-001**: システムはユーザーがファイル選択ボタンまたはドラッグ&ドロップで文書をアップロードできる機能を提供しなければならない
- **FR-002**: システムはPDF、Word（.docx）、Excel（.xlsx）、画像（.jpg, .png）形式のファイルをサポートしなければならない
- **FR-003**: システムは1ファイルあたり最大10MB、1回のアップロードで最大20ファイルまでの制限を適用しなければならない
- **FR-004**: システムはアップロード中のファイルごとにプログレスバーを表示しなければならない
- **FR-005**: システムはアップロード時にファイル名、タグを設定できる入力フォームを提供しなければならない
- **FR-006**: システムは対応していないファイル形式やサイズ超過の場合、明確なエラーメッセージを表示しなければならない

#### 文書一覧表示

- **FR-007**: システムはアップロードされた文書をリストビューまたはグリッドビュー（カード形式）で表示しなければならない
- **FR-008**: 各文書の表示には、ファイル名、タグ、アップロード日時、ファイルサイズ、アップロードユーザーを含めなければならない
- **FR-009**: システムはファイル名（昇順/降順）、更新日時（新しい順/古い順）、ファイルサイズ（大きい順/小さい順）でソート機能を提供しなければならない
- **FR-010**: システムは1ページあたり20件の文書を表示し、ページネーション機能を提供しなければならない
- **FR-011**: システムはリストビューとグリッドビューの切り替えボタンを提供しなければならない

#### タグ管理

- **FR-012**: システムはユーザーが自由にタグを作成、名前変更、削除できるタグ管理機能を提供しなければならない
- **FR-013**: 1つの文書に複数のタグを付与できなければならない
- **FR-014**: システムはタグに色（赤、青、緑、黄色など）を設定して視覚的に区別できる機能を提供しなければならない
- **FR-014**: システムはタグに色（赤、青、緑、黄色など）を設定して視覚的に区別できる機能を提供しなければならない
- **FR-015**: タグが複数の文書で使用されている場合、削除時に警告メッセージを表示しなければならない

#### 検索とフィルタリング

- **FR-016**: システムはファイル名とタグ名でキーワード検索ができる検索バーを提供しなければならない
- **FR-017**: 検索結果のファイル名とタグ名は、一致した部分をハイライト表示しなければならない
- **FR-018**: システムはタグでフィルタ（複数選択可）機能を提供しなければならない
- **FR-019**: システムはアップロード日付範囲（開始日〜終了日）でフィルタ機能を提供しなければならない
- **FR-020**: システムは検索条件を名前付きで保存し、再利用できる機能を提供しなければならない
- **FR-021**: 検索結果が0件の場合、「該当する文書が見つかりませんでした」とメッセージを表示しなければならない

#### 文書詳細表示とダウンロード

- **FR-022**: システムは文書をクリックすると詳細画面を表示しなければならない
- **FR-023**: 詳細画面にはファイル名、タグ、アップロード日時、ファイルサイズ、アップロードユーザーを表示しなければならない
- **FR-024**: システムはPDFと画像ファイルをブラウザ内でプレビュー表示しなければならない
- **FR-025**: システムはダウンロードボタンで元のファイルをローカルに保存できる機能を提供しなければならない
- **FR-026**: システムは複数の文書を選択して一括ダウンロード（ZIP形式）できる機能を提供しなければならない

#### 文書編集

- **FR-027**: システムは文書のファイル名を変更できる機能を提供しなければならない
- **FR-028**: システムはタグを変更（追加・削除）できる機能を提供しなければならない
- **FR-029**: 編集内容は保存ボタンをクリックして反映され、文書一覧にも即座に反映されなければならない

#### 文書削除とゴミ箱

- **FR-030**: システムは文書削除時に「この文書を削除しますか？」と確認ダイアログを表示しなければならない
- **FR-031**: 削除された文書はゴミ箱に移動し、元の場所から削除されなければならない
- **FR-032**: システムはゴミ箱から文書を復元する機能を提供しなければならない
- **FR-033**: ゴミ箱の文書は30日間保持され、その後自動的に完全削除されなければならない
- **FR-034**: システムは複数の文書を選択して一括削除できる機能を提供しなければならない

#### ユーザビリティ

- **FR-035**: システムは同名ファイルのアップロード時に上書き確認ダイアログを表示しなければならない
- **FR-036**: システムはアップロード中のネットワークエラー発生時に再試行ボタンを提供しなければならない
- **FR-037**: システムは文書一覧で複数選択（Shift+クリック、Ctrl+クリック）をサポートしなければならない
- **FR-038**: システムはレスポンシブ対応でデスクトップとタブレットで快適に操作できなければならない

### Key Entities

- **文書 (Document)**: システムで管理される主要なエンティティ。属性として文書ID、ファイル名、タグ（複数）、アップロード日時、更新日時、ファイルサイズ、ファイル形式、アップロードユーザーID、削除フラグ（ゴミ箱に移動しているか）、削除日時を持つ
- **タグ (Tag)**: 文書に付与されるラベル。属性としてタグID、タグ名、色（赤/青/緑/黄色など）、作成日時、更新日時を持つ
- **文書タグ関連 (DocumentTag)**: 文書とタグの多対多関係を管理。属性として文書ID、タグID、付与日時を持つ
- **ユーザー (User)**: システムを利用する人。属性としてユーザーID、名前、メールアドレス、役割（管理者/一般ユーザー）、作成日時を持つ
- **保存された検索条件 (SavedSearchCondition)**: ユーザーが保存した検索条件。属性として検索条件ID、ユーザーID、条件名、タグフィルタ、日付範囲フィルタ、作成日時を持つ

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: ユーザーは文書のアップロードから一覧表示まで10秒以内に完了できる（通常のネットワーク環境、5MBのファイル）
- **SC-002**: キーワード検索の応答時間が1秒以内である（100件の文書が登録されている状態）
- **SC-003**: システムは100件の文書を登録した状態でも、一覧表示、ソート、フィルタが快適に動作する（応答時間2秒以内）
- **SC-004**: 初めて使うユーザーが、マニュアルなしで文書をアップロード・検索できる（5分以内にタスク完了）
- **SC-005**: ユーザーの80%以上が「従来のファイルサーバーより文書を探しやすい」と回答する（満足度調査）
- **SC-006**: 文書の検索にかかる時間が、従来のファイルサーバーと比較して50%以上短縮される（平均検索時間の測定）
- **SC-007**: システムは50人の同時ユーザーを処理でき、応答時間が3秒以内を維持する
- **SC-008**: 誤削除された文書の90%以上がゴミ箱から復元される（ゴミ箱の利用率）
- **SC-009**: ユーザーの70%以上が検索条件保存機能を使用し、繰り返し検索の時間が60%削減される
- **SC-010**: PDFと画像のプレビュー機能により、不要なダウンロードが40%削減される

## Assumptions

- 認証機能は既存の001-user-auth実装を再利用し、ログイン画面、セッション管理、パスワード検証ロジックをそのまま使用する。文書管理機能は認証後のダッシュボードに統合される
- アクセス権限は全ユーザーが全文書を閲覧・編集可能とし、個別の権限設定は実装しない（全ユーザーが同じチームとして扱われる）
- ユーザー管理は管理者と一般ユーザーの2役割のみをサポートし、管理者はタグ管理とユーザー管理、一般ユーザーは文書管理のみ可能
- ファイルストレージはバックエンド側で実装され、フロントエンドはOpenAPI仕様に基づいたモックAPIを使用する。実際のストレージ実装（ローカルファイルシステム、AWS S3、Azure Blob Storage等）はバックエンド開発時に決定される
- 同時アクセスユーザー数は最大50人を想定し、それを超える場合は将来的なスケーリングを検討
- ファイルの総容量は1TB以内を想定し、それを超える場合はストレージの拡張が必要
- UI言語は日本語と英語に対応し、react-i18next等のライブラリを使用して多言語化を実装する。言語切り替えボタンをヘッダーに配置し、選択した言語設定はブラウザのlocalStorageに保存される
- レスポンシブ対応はデスクトップ（1920x1080以上）とタブレット（768x1024以上）のみを対象とし、スマホは対象外
- ブラウザサポート範囲はモダンブラウザの最新2バージョン（Chrome 120+, Firefox 120+, Safari 17+, Edge 120+）とし、ES2022+の機能を使用可能とする。ポリフィルは不要
- 文書のバージョン管理機能は初期段階では実装せず、上書きアップロードのみをサポート
- 同時編集時の競合処理は後勝ち（Last Write Wins）方式を採用し、楽観的ロックや編集ロックは実装しない。複数ユーザーが同時に同じ文書を編集した場合、最後に保存したユーザーの変更が反映される
- ゴミ箱の自動削除は日次バッチ処理で実行され、30日経過後に完全削除される
